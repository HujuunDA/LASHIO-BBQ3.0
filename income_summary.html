<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶å…¥æ±‡æ€»</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            min-height: 100vh;
            padding-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* --- é¡¶éƒ¨æ  --- */
        .header-bar {
            background-color: #4CAF50; /* ç»¿è‰² */
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
        }

        .header-button {
            background: #e6523f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- æ±‡æ€»é¢æ¿ --- */
        .summary-panel {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
            background-color: #e8f5e9; 
            border-bottom: 2px solid #4CAF50;
        }

        .summary-card {
            text-align: center;
            flex: 1;
            padding: 10px 5px;
            border-right: 1px solid #ddd;
        }
        
        .summary-card:last-child {
            border-right: none;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #388e3c; 
            margin-bottom: 5px;
        }
        
        .summary-value.red {
            color: #d85050; 
        }

        .summary-label {
            font-size: 0.8em;
            color: #666;
        }

        /* --- è®¢å•åˆ—è¡¨ --- */
        .order-list-section {
            padding: 20px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
        }

        /* --- é€šç”¨è®¢å•é¡¹æ ·å¼ (ç”¨äºå¾…ç»“ç®—å’Œå·²ç»“ç®—) --- */
        .order-item-card {
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .order-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #fcc;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        
        .order-table {
            font-size: 1.2em;
            font-weight: bold;
            color: #d85050;
        }

        .order-total {
            font-size: 1.4em;
            font-weight: bold;
            color: #d85050;
        }

        .order-details {
            font-size: 0.9em;
            color: #555;
            padding: 5px 0;
        }
        
        .detail-line {
            display: flex;
            justify-content: space-between;
            line-height: 1.5;
            border-bottom: 1px dotted #eee;
        }
        
        .detail-line:last-child {
            border-bottom: none;
        }
        
        .clear-income-btn {
            display: block;
            width: 90%;
            margin: 30px auto 10px;
            padding: 12px;
            background-color: #ff5722; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .no-pending {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <span>ğŸ’° è´¢åŠ¡æ±‡æ€»</span>
            <button class="header-button" onclick="goToOrderingPage()">è¿”å›ç‚¹å•</button>
        </div>

        <div class="summary-panel">
            <div class="summary-card">
                <div class="summary-value" id="totalIncome">0</div>
                <div class="summary-label">ç´¯è®¡æ€»æ”¶å…¥ (Ks)</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="closedOrdersCount">0</div>
                <div class="summary-label">å·²ç»“ç®—è®¢å•æ•°</div>
            </div>
            <div class="summary-card">
                <div class="summary-value red" id="pendingOrdersCount">0</div>
                <div class="summary-label">æœªç»“ç®—æ¡Œæ•°</div>
            </div>
        </div>

        <div class="order-list-section">
            <div class="section-title">
                ğŸ”´ å¾…ç»“ç®—æ¡Œå· (å½“å‰è®¢å•è¯¦æƒ…)
            </div>
            <div id="pendingOrdersList">
                <div class="no-pending">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œä¸­çš„è®¢å•ã€‚</div>
            </div>
        </div>
        
        <div class="closed-orders-section">
            <div class="section-title">
                ğŸŸ¢ å·²ç»“ç®—è®°å½• (æŒ‰æœ€æ–°æ’åº)
            </div>
            <div id="closedOrdersList">
                <div class="no-pending">æš‚æ— å·²ç»“ç®—è®°å½•ã€‚</div>
            </div>
            <button class="clear-income-btn" onclick="clearAllIncome()">æ¸…ç©ºæ‰€æœ‰æ”¶å…¥è®°å½•</button>
        </div>

    </div>

<script>
    const ORDERS_STORAGE_KEY = 'grill_table_orders';
    const INCOME_STORAGE_KEY = 'grill_income_data';

    // --- å®ç”¨å‡½æ•° ---
    function loadTableOrders() {
        const storedOrders = localStorage.getItem(ORDERS_STORAGE_KEY);
        if (storedOrders) {
            try {
                const obj = JSON.parse(storedOrders);
                return new Map(Object.entries(obj));
            } catch (e) {
                console.error("Failed to parse table orders:", e);
            }
        }
        return new Map();
    }
    
    function loadIncomeData() {
        const storedData = localStorage.getItem(INCOME_STORAGE_KEY);
        if (storedData) {
            try {
                return JSON.parse(storedData);
            } catch (e) {
                console.error("Failed to parse income data:", e);
            }
        }
        return { total: 0, closedOrders: [] };
    }

    function calculateOrderTotal(order) {
        return order.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
    
    function calculateOrderSummary(order) {
        const activeItems = order.filter(item => item.quantity > 0);
        const total = calculateOrderTotal(order);
        
        const details = activeItems.map(item => ({
             name: item.name,
             quantity: item.quantity,
             price: item.price
        }));
        
        return { total, details };
    }

    /**
     * åˆ›å»ºè®¢å•è¯¦æƒ…çš„HTMLç»“æ„
     * @param {object} record - åŒ…å« table, amount, time, items çš„è®¢å•è®°å½•
     * @param {boolean} isClosed - æ˜¯å¦ä¸ºå·²ç»“ç®—è®¢å•
     */
    function createDetailedOrderHTML(record, isClosed) {
        let detailsHTML = '';
        if (record.items && record.items.length > 0) {
            record.items.forEach(item => {
                const subtotal = (item.price * item.quantity).toLocaleString();
                detailsHTML += `
                    <div class="detail-line">
                        <span>${item.name} x ${item.quantity}</span>
                        <span style="font-weight: bold;">${subtotal} Ks</span>
                    </div>
                `;
            });
        } else {
             detailsHTML = '<div style="color:#aaa; text-align:center;">(æ— è¯¦ç»†èœå“è®°å½•)</div>';
        }
        
        return `
            <div class="order-item-card" style="background-color: ${isClosed ? '#f8fdf8' : '#fff4f4'}; border: 1px solid ${isClosed ? '#d4edda' : '#f5c6cb'};">
                <div class="order-header-info">
                    <span class="order-table">${isClosed ? 'ç»“ç®—æ—¶é—´' : 'æ¡Œå·'}ï¼š${isClosed ? record.time : record.table + 'å·æ¡Œ'}</span>
                    <span class="order-total">${record.amount.toLocaleString()} Ks</span>
                </div>
                <div class="order-details">
                   ${detailsHTML}
                </div>
            </div>
        `;
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderSummary() {
        const incomeData = loadIncomeData();
        const tableOrdersMap = loadTableOrders();
        
        let pendingOrdersListHTML = '';
        let pendingTableCount = 0;

        // --- æ¸²æŸ“å¾…ç»“ç®—åˆ—è¡¨ (è¯»å– ORDERS_STORAGE_KEY) ---
        tableOrdersMap.forEach((order, tableNumber) => {
            const summary = calculateOrderSummary(order);
            if (summary.total > 0) {
                pendingTableCount++;
                const record = { 
                    table: tableNumber, 
                    items: summary.details, 
                    amount: summary.total 
                };
                pendingOrdersListHTML += createDetailedOrderHTML(record, false);
            }
        });
        
        const pendingOrdersListContainer = document.getElementById('pendingOrdersList');
        if (pendingTableCount > 0) {
            pendingOrdersListContainer.innerHTML = pendingOrdersListHTML;
        } else {
            pendingOrdersListContainer.innerHTML = '<div class="no-pending">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œä¸­çš„è®¢å•ã€‚</div>';
        }


        // --- æ¸²æŸ“å·²ç»“ç®—åˆ—è¡¨ (è¯»å– INCOME_STORAGE_KEY) ---
        let closedOrdersListHTML = '';
        const closedOrdersListContainer = document.getElementById('closedOrdersList');
        
        if (incomeData.closedOrders.length > 0) {
            // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤º (æœ€æ–°åœ¨æœ€ä¸Š)
            const reversedOrders = [...incomeData.closedOrders].reverse(); 
            reversedOrders.forEach(record => {
                closedOrdersListHTML += createDetailedOrderHTML(record, true);
            });
            closedOrdersListContainer.innerHTML = closedOrdersListHTML;
        } else {
            closedOrdersListContainer.innerHTML = '<div class="no-pending">æš‚æ— å·²ç»“ç®—è®°å½•ã€‚</div>';
        }

        // --- æ¸²æŸ“æ±‡æ€»é¢æ¿ ---
        document.getElementById('totalIncome').textContent = incomeData.total.toLocaleString();
        document.getElementById('closedOrdersCount').textContent = incomeData.closedOrders.length;
        document.getElementById('pendingOrdersCount').textContent = pendingTableCount;
    }

    function clearAllIncome() {
        if (confirm("è­¦å‘Šï¼æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çš„æ”¶å…¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä¸”ä¸ä¼šå½±å“å½“å‰æœªç»“ç®—çš„è®¢å•ã€‚")) {
            localStorage.setItem(INCOME_STORAGE_KEY, '{"total": 0, "closedOrders": []}');
            renderSummary();
            alert("æ‰€æœ‰æ”¶å…¥è®°å½•å·²æ¸…ç©ºã€‚");
        }
    }
    
    function goToOrderingPage() {
        // ************ ä¿®å¤åŒºåŸŸ START ************
        window.location.href = 'index.html'; // é“¾æ¥åˆ°å¸¦ç©ºæ ¼çš„ä¸»æ–‡ä»¶
        // ************ ä¿®å¤åŒºåŸŸ END ************
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderSummary();
    });
</script>

</body>
</html>