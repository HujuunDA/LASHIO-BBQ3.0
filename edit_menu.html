<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘èœå•</title>
    <style>
        /* --- çƒ§çƒ¤æ©™è‰²ä¸»é¢˜ CSS ä¿®æ”¹ --- */
        body { font-family: Arial, sans-serif; margin: 0; padding-top: 0; background-color: #f4f4f4; }
        .header-bar { 
            background-color: #FF8C00; /* ä¸»è‰²ï¼šæ©™è‰² */
            color: white; 
            padding: 10px 20px; 
            box-sizing: border-box; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
        }
        .header-bar h2 { margin: 0; font-size: 1.2em; }
        .header-bar button { 
            background: #FF4500; /* å¼ºè°ƒè‰²ï¼šæ©™çº¢è‰² */
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s;
        }
        .menu-list { padding: 20px; margin-top: 50px; } 
        .add-item-btn { 
            display: block; 
            width: 90%; 
            margin: 20px auto; 
            padding: 15px; 
            background-color: #FF8C00; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        /* Modal Styles (ä¿æŒæ©™è‰²ä¸»é¢˜) */
        .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 25px; border-radius: 10px; width: 90%; max-width: 350px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .modal-content h3 { color: #FF4500; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .save-btn { background-color: #34c759; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .cancel-btn { background-color: #ccc; color: #333; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* æ–°å¢åŠ è½½å±‚æ ·å¼ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); color: #FF8C00; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; z-index: 1000; transition: opacity 0.3s; }
        
        /* Menu Item Styles */
        .menu-item { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .item-info .name { font-size: 16px; font-weight: bold; }
        .item-info .price-cat { font-size: 14px; color: #666; margin-top: 5px; }
        .actions button { padding: 5px 10px; border: none; border-radius: 5px; margin-left: 5px; cursor: pointer; font-weight: 500; }
        .edit-btn { background-color: #FF8C00; color: white; }
        .delete-btn { background-color: #FF4500; color: white; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; margin: 8px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
    </style>
</head>
<body>
    
    <div id="loading-overlay" style="display: flex;"> æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®... ğŸš€ </div>

    <header class="header-bar">
        <h2>ğŸ“ ç¼–è¾‘èœå•</h2>
        <button onclick="goToOrderingPage()">è¿”å›ç‚¹å•</button>
    </header>

    <main class="menu-list" id="menuList">
    </main>

    <button class="add-item-btn" id="openModalBtn">â• æ·»åŠ æ–°èœå“</button>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">æ·»åŠ æ–°èœå“</h3>
            <form id="itemForm">
                <input type="hidden" id="itemId">
                <label for="itemName">èœå“åç§°:</label>
                <input type="text" id="itemName" required>

                <label for="itemPrice">ä»·æ ¼ (Ks):</label>
                <input type="number" id="itemPrice" min="1" required>

                <label for="itemCategory">åˆ†ç±»:</label>
                <select id="itemCategory" required>
                    </select>

                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn" id="saveBtn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Cloud Sync Configuration (å·²æ›´æ–°ä¸ºæ‚¨æä¾›çš„æ–°ä¿¡æ¯) ---
        const JSONBIN_ID = '69174442ae596e708f5901ae'; 
        const JSONBIN_MASTER_KEY = '$2a$10$ol9N5tLV0G2AnDYaF4sO4O2l0RoR8OSXagA4IUy2wiwdntZDuzRh2';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

        let globalCloudData = {
            menu_data: [],
            table_orders: {}, 
            income_data: { total: 0, closedOrders: [] },
            purchase_data: { productTemplate: {}, cartData: [] }
        };
        let menuItems = [];
        const menuList = document.getElementById('menuList');
        const itemModal = document.getElementById('itemModal');
        const itemForm = document.getElementById('itemForm');
        const itemCategorySelect = document.getElementById('itemCategory');

        // --- Cloud Utilities ---
        async function loadCloudData() {
            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`Cloud fetch failed: ${response.statusText}`);
                const data = await response.json();
                if (data.record) {
                    globalCloudData = data.record;
                    if (!globalCloudData.menu_data) globalCloudData.menu_data = [];
                    menuItems = globalCloudData.menu_data;
                }
            } catch (error) {
                console.error("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤æ•°æ®ã€‚", error);
                alert("äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
            }
        }

        async function saveCloudData() {
            globalCloudData.menu_data = menuItems;
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(globalCloudData)
                });
                if (!response.ok) throw new Error(`Cloud save failed: ${response.statusText}`);
                console.log("æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚");
                return true;
            } catch (error) {
                console.error("ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ã€‚", error);
                alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
                return false;
            }
        }
        
        // --- æ ¸å¿ƒé€»è¾‘ ---
        function generateUniqueId() {
            return 'item_' + Date.now() + Math.random().toString(36).substr(2, 9);
        }

        function renderMenu() {
            menuList.innerHTML = '';
            
            if (menuItems.length === 0) {
                 menuList.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">èœå•ä¸ºç©ºï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ èœå“ã€‚</p>';
                 return;
            }

            // æŒ‰åˆ†ç±»åˆ†ç»„
            const categorizedItems = menuItems.reduce((acc, item) => {
                const category = item.category || 'æœªåˆ†ç±»';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            for (const category in categorizedItems) {
                // ç±»åˆ«æ ‡é¢˜
                const categoryHeader = document.createElement('h3');
                categoryHeader.className = 'category-header';
                categoryHeader.textContent = category;
                categoryHeader.style.cssText = 'background-color: #FFE4B5; color: #FF4500; padding: 10px; margin-top: 20px; border-radius: 5px;';
                menuList.appendChild(categoryHeader);

                // èœå“åˆ—è¡¨
                categorizedItems[category].forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'menu-item';
                    itemElement.innerHTML = `
                        <div class="item-info">
                            <div class="name">${item.name}</div>
                            <div class="price-cat">ä»·æ ¼: ${item.price.toLocaleString()} Ks</div>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editItem('${item.id}')">ç¼–è¾‘</button>
                            <button class="delete-btn" onclick="deleteItem('${item.id}')">åˆ é™¤</button>
                        </div>
                    `;
                    menuList.appendChild(itemElement);
                });
            }
            renderCategoryOptions();
        }

        function renderCategoryOptions() {
            const categories = [...new Set(menuItems.map(item => item.category))].filter(c => c);
            itemCategorySelect.innerHTML = '<option value="">-- é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±» --</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                itemCategorySelect.appendChild(option);
            });
            
            // å…è®¸æ·»åŠ æ–°åˆ†ç±»
            const newOption = document.createElement('option');
            newOption.value = 'new_category';
            newOption.textContent = 'â• æ–°å¢åˆ†ç±»...';
            itemCategorySelect.appendChild(newOption);
            
            itemCategorySelect.onchange = function() {
                if (this.value === 'new_category') {
                    const newCat = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:');
                    if (newCat) {
                        const newOpt = document.createElement('option');
                        newOpt.value = newCat;
                        newOpt.textContent = newCat;
                        itemCategorySelect.insertBefore(newOpt, itemCategorySelect.lastChild);
                        itemCategorySelect.value = newCat;
                    } else {
                         itemCategorySelect.value = itemCategorySelect.options[0].value;
                    }
                }
            };
        }

        async function addItem(event) {
            event.preventDefault();
            
            const id = document.getElementById('itemId').value;
            const name = document.getElementById('itemName').value;
            const price = parseInt(document.getElementById('itemPrice').value, 10);
            const category = document.getElementById('itemCategory').value;
            
            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è¯·å¡«å†™å®Œæ•´çš„èœå“ä¿¡æ¯ï¼ˆåç§°ã€æœ‰æ•ˆä»·æ ¼å’Œåˆ†ç±»ï¼‰ã€‚');
                return;
            }

            const categoryName = category === 'new_category' ? prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:') : category;
            if (!categoryName) return; 

            let newItem = { name, price, category: categoryName };

            if (id) {
                // ç¼–è¾‘ç°æœ‰èœå“
                const index = menuItems.findIndex(item => item.id === id);
                if (index !== -1) {
                    menuItems[index] = { ...menuItems[index], ...newItem };
                }
            } else {
                // æ·»åŠ æ–°èœå“
                newItem.id = generateUniqueId();
                menuItems.push(newItem);
            }

            const saved = await saveCloudData();
            if (saved) {
                hideModal();
                renderMenu();
            }
        }

        function editItem(id) {
            const item = menuItems.find(i => i.id === id);
            if (!item) return;

            showModal('ç¼–è¾‘èœå“');
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            
            // ç¡®ä¿åˆ†ç±»é€‰é¡¹å­˜åœ¨
            renderCategoryOptions(); 
            // å°è¯•ç›´æ¥è®¾ç½®å€¼
            document.getElementById('itemCategory').value = item.category;
             // å¦‚æœç›´æ¥è®¾ç½®å¤±è´¥ (ä¾‹å¦‚: åˆ†ç±»æ˜¯é€šè¿‡ prompt æ·»åŠ çš„)ï¼Œåˆ™éœ€è¦é‡æ–°è®¾ç½®
            if (document.getElementById('itemCategory').value !== item.category) {
                const newOpt = document.createElement('option');
                newOpt.value = item.category;
                newOpt.textContent = item.category;
                itemCategorySelect.insertBefore(newOpt, itemCategorySelect.lastChild);
                itemCategorySelect.value = item.category;
            }
        }

        async function deleteItem(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤èœå“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                menuItems = menuItems.filter(item => item.id !== id);
                const saved = await saveCloudData();
                if (saved) {
                    renderMenu();
                }
            }
        }
        
        function showModal(title) {
            document.getElementById('modalTitle').textContent = title;
            itemModal.style.display = 'flex';
        }

        function hideModal() {
            itemModal.style.display = 'none';
            // é‡ç½®è¡¨å•å’ŒID
            itemForm.reset();
            document.getElementById('itemId').value = '';
        }

        // --- é¡µé¢è·³è½¬ (FIXED: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶å `index.html` - ä¿®å¤ç‚¹ï¼) ---
        function goToOrderingPage() {
            window.location.href = 'index.html'; 
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('openModalBtn').onclick = () => {
                showModal('æ·»åŠ æ–°èœå“');
                renderCategoryOptions(); // ç¡®ä¿æ‰“å¼€å‰åŠ è½½æœ€æ–°åˆ†ç±»
            };
            document.getElementById('itemForm').onsubmit = addItem;
            
            await loadCloudData();
            document.getElementById('loading-overlay').style.display = 'none';
            renderMenu();
        });
    </script>
</body>
</html>