<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶å…¥æ±‡æ€»</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            min-height: 100vh;
            padding-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* --- é¡¶éƒ¨æ  --- */
        .header-bar {
            background-color: #FF8C00; /* ç»Ÿä¸€ä¸ºæ©™è‰²ä¸»é¢˜ */
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
        }

        .header-button {
            background: #FF4500; /* ç»Ÿä¸€ä¸ºæ©™çº¢è‰² */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- æ±‡æ€»é¢æ¿ --- */
        .summary-panel {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
            background-color: #ffe4b5; /* æµ…æ©™è‰²èƒŒæ™¯ */
            border-bottom: 2px solid #FF8C00;
        }

        .summary-card {
            text-align: center;
            flex: 1;
            padding: 10px 5px;
            border-right: 1px solid #ffaa55;
        }
        
        .summary-card:last-child {
            border-right: none;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FF4500; /* æ©™çº¢è‰² */
            margin-bottom: 5px;
        }
        
        .summary-value.red {
            color: #d85050; 
        }

        .summary-label {
            font-size: 0.8em;
            color: #666;
        }

        /* --- è®¢å•åˆ—è¡¨ --- */
        .order-list-section {
            padding: 20px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
        }

        /* --- é€šç”¨è®¢å•é¡¹æ ·å¼ (ç”¨äºå¾…ç»“ç®—å’Œå·²ç»“ç®—) --- */
        .order-item-card {
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .order-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #fcc;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        
        .order-table {
            font-size: 1.2em;
            font-weight: bold;
            color: #FF8C00; /* æ©™è‰² */
        }

        .order-total {
            font-size: 1.4em;
            font-weight: bold;
            color: #FF4500; /* æ©™çº¢è‰² */
        }

        .order-details {
            font-size: 0.9em;
            color: #555;
            padding: 5px 0;
        }
        
        .detail-line {
            display: flex;
            justify-content: space-between;
            line-height: 1.5;
            border-bottom: 1px dotted #eee;
        }
        
        .detail-line:last-child {
            border-bottom: none;
        }
        
        .clear-income-btn {
            display: block;
            width: 90%;
            margin: 30px auto 10px;
            padding: 12px;
            background-color: #ff5722; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .no-pending {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 0.9em;
        }
        
        /* æ–°å¢åŠ è½½å±‚æ ·å¼ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); color: #FF8C00; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; z-index: 1000; transition: opacity 0.3s; }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display: flex;"> æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®... ğŸš€ </div>

    <div class="container">
        <div class="header-bar">
            <span>ğŸ’° è´¢åŠ¡æ±‡æ€»</span>
            <button class="header-button" onclick="goToOrderingPage()">è¿”å›ç‚¹å•</button>
        </div>

        <div class="summary-panel">
            <div class="summary-card">
                <div class="summary-value" id="totalIncome">0</div>
                <div class="summary-label">ç´¯è®¡æ€»æ”¶å…¥ (Ks)</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="closedOrdersCount">0</div>
                <div class="summary-label">å·²ç»“ç®—è®¢å•æ•°</div>
            </div>
            <div class="summary-card">
                <div class="summary-value red" id="pendingOrdersCount">0</div>
                <div class="summary-label">æœªç»“ç®—æ¡Œæ•°</div>
            </div>
        </div>

        <div class="order-list-section">
            <div class="section-title">
                ğŸ”´ å¾…ç»“ç®—æ¡Œå· (å½“å‰è®¢å•è¯¦æƒ…)
            </div>
            <div id="pendingOrdersList">
                <div class="no-pending">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œä¸­çš„è®¢å•ã€‚</div>
            </div>
        </div>
        
        <div class="closed-orders-section">
            <div class="section-title">
                ğŸŸ¢ å·²ç»“ç®—è®°å½• (æŒ‰æœ€æ–°æ’åº)
            </div>
            <div id="closedOrdersList">
                <div class="no-pending">æš‚æ— å·²ç»“ç®—è®°å½•ã€‚</div>
            </div>
            <button class="clear-income-btn" onclick="clearAllIncome()">æ¸…ç©ºæ‰€æœ‰æ”¶å…¥è®°å½•</button>
        </div>

    </div>

<script>
    // --- Cloud Sync Configuration (ä¸ index.html ä¿æŒä¸€è‡´) ---
    // è¿™æ˜¯ä½ çš„äº‘ç«¯å­˜å‚¨IDå’Œå¯†é’¥ï¼Œç¡®ä¿å’Œä½ çš„ index.html ä¸­çš„å€¼æ˜¯å®Œå…¨ä¸€æ ·çš„
    const JSONBIN_ID = '69174442ae596e708f5901ae'; 
    const JSONBIN_MASTER_KEY = '$2a$10$ol9N5tLV0G2AnDYaF4sO4O2l0RoR8OSXagA4IUy2wiwdntZDuzRh2';
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

    let globalCloudData = {
        menu_data: [],
        table_orders: {}, 
        income_data: { total: 0, closedOrders: [] },
        purchase_data: { productTemplate: {}, cartData: [] }
    };
    
    // ç”¨äºå­˜å‚¨ table_orders çš„ Map ç»“æ„
    let tableOrders = new Map(); 

    // --- Cloud Utilities (æ ¸å¿ƒï¼šä»äº‘ç«¯åŠ è½½æ•°æ®) ---
    async function loadCloudData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const response = await fetch(JSONBIN_URL + '/latest', {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Cloud fetch failed: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.record) {
                globalCloudData = data.record;
                // ç¡®ä¿æ‰€æœ‰é¡¶å±‚å±æ€§éƒ½å­˜åœ¨
                if (!globalCloudData.menu_data) globalCloudData.menu_data = [];
                if (!globalCloudData.table_orders) globalCloudData.table_orders = {};
                if (!globalCloudData.income_data) globalCloudData.income_data = { total: 0, closedOrders: [] };
                if (!globalCloudData.purchase_data) globalCloudData.purchase_data = { productTemplate: {}, cartData: [] };

                // è½¬æ¢ table_orders ä¸º Map
                tableOrders = new Map();
                for (const [tableNum, orderData] of Object.entries(globalCloudData.table_orders)) {
                    // å…¼å®¹æ—§çš„åªå­˜æ•°ç»„çš„ç»“æ„
                    if (Array.isArray(orderData)) {
                         tableOrders.set(tableNum, { items: orderData, notes: '' });
                    } else {
                        // ç¡®ä¿ items å’Œ notes å­˜åœ¨
                        if (!orderData.items) orderData.items = [];
                        if (typeof orderData.notes !== 'string') orderData.notes = '';
                        tableOrders.set(tableNum, orderData);
                    }
                }
                console.log("æ•°æ®ä»äº‘ç«¯åŠ è½½æˆåŠŸã€‚", globalCloudData);
            } else {
                console.warn("äº‘ç«¯æ•°æ®ç»“æ„ä¸å®Œæ•´æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ç»“æ„ã€‚", data);
            }
            
            renderSummary(); // åŠ è½½æˆåŠŸåæ¸²æŸ“é¡µé¢
        } catch (error) {
            console.error("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤æ•°æ®ã€‚", error);
            // æé†’ç”¨æˆ·åŠ è½½å¤±è´¥ï¼Œä½†ä¸ä½¿ç”¨ alert é¿å…é˜»å¡
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.textContent = 'âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œã€‚';
            loadingOverlay.style.backgroundColor = 'rgba(255, 230, 230, 0.9)';
            loadingOverlay.style.color = '#FF4500';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 3000);
        } finally {
             document.getElementById('loading-overlay').style.display = 'none';
        }
    }
    
    // --- Cloud Utilities (ç”¨äºæ¸…ç©ºæ”¶å…¥æ—¶åŒæ­¥åˆ°äº‘ç«¯) ---
    async function saveCloudData() {
        // ç¡®ä¿ tableOrders è½¬æ¢å› Object ä»¥ä¾¿ä¿å­˜
        const storableTableOrders = {};
        for (const [tableNum, data] of tableOrders.entries()) {
            // åªä¿å­˜æœ‰è®¢å•é¡¹æˆ–æœ‰å¤‡æ³¨çš„æ¡Œå·
            if (data.items.length > 0 || data.notes) {
                storableTableOrders[tableNum] = data;
            }
        }
        globalCloudData.table_orders = storableTableOrders;
        
        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT', // ä½¿ç”¨ PUT æ›´æ–°æ•´ä¸ª Bin
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(globalCloudData)
            });

            if (!response.ok) {
                throw new Error(`Cloud save failed: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log("æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚", result);
            return true;
        } catch (error) {
            console.error("ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ã€‚", error);
            alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
            return false;
        }
    }

    // --- å®ç”¨å‡½æ•° ---
    // (å·²ç§»é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨ç›¸å…³çš„ä»£ç ï¼Œç¡®ä¿åªä½¿ç”¨äº‘ç«¯æ•°æ®)

    function calculateOrderTotal(orderItems) {
        // orderItems æ˜¯ { items: [], notes: '' } ç»“æ„ä¸­çš„ items æ•°ç»„
        return orderItems.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
    
    function calculateOrderSummary(orderData) {
        // orderData æ˜¯ { items: [], notes: '' } ç»“æ„
        const activeItems = orderData.items.filter(item => item.quantity > 0);
        const total = calculateOrderTotal(activeItems);
        
        const details = activeItems.map(item => ({
             name: item.name,
             quantity: item.quantity,
             price: item.price
        }));
        
        return { total, details };
    }

    /**
     * åˆ›å»ºè®¢å•è¯¦æƒ…çš„HTMLç»“æ„
     */
    function createDetailedOrderHTML(record, isClosed) {
        const itemsToDisplay = isClosed ? record.items : record.details;
        
        let detailsHTML = '';
        if (itemsToDisplay && itemsToDisplay.length > 0) {
            itemsToDisplay.forEach(item => {
                // ç¡®ä¿ total æ˜¯æ•°å­—ï¼Œå¹¶æ ¼å¼åŒ–æ˜¾ç¤º
                const subtotal = (item.price * item.quantity);
                detailsHTML += `
                    <div class="detail-line">
                        <span>${item.name} x ${item.quantity}</span>
                        <span style="font-weight: bold;">${subtotal.toLocaleString()} Ks</span>
                    </div>
                `;
            });
        } else {
             detailsHTML = '<div style="color:#aaa; text-align:center;">(æ— è¯¦ç»†èœå“è®°å½•)</div>';
        }
        
        // å¦‚æœæœ‰å¤‡æ³¨ï¼Œæ·»åŠ å¤‡æ³¨è¡Œ
        let notesHTML = '';
        const notes = isClosed ? record.notes : record.notes; // ç»Ÿä¸€åç§°
        if (notes) {
            notesHTML = `<div style="margin-top: 5px; font-style: italic; color: #FF4500;">å¤‡æ³¨: ${notes}</div>`;
        }
        
        let headerText = '';
        let totalDisplay = record.total.toLocaleString();
        
        if (isClosed) {
            const date = new Date(record.timestamp);
            const timeString = `${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            headerText = `æ¡Œå· ${record.table} - ç»“ç®—æ—¶é—´: ${timeString}`;
        } else {
            headerText = `æ¡Œå·ï¼š${record.table}å·æ¡Œ`;
        }

        
        return `
            <div class="order-item-card" style="background-color: ${isClosed ? '#f8fdf8' : '#fff4f4'}; border: 1px solid ${isClosed ? '#d4edda' : '#f5c6cb'};">
                <div class="order-header-info">
                    <span class="order-table">${headerText}</span>
                    <span class="order-total">${totalDisplay} Ks</span>
                </div>
                <div class="order-details">
                   ${detailsHTML}
                   ${notesHTML}
                </div>
            </div>
        `;
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderSummary() {
        // ä½¿ç”¨ globalCloudData ä¸­çš„æ•°æ®
        const incomeData = globalCloudData.income_data;
        
        let pendingOrdersListHTML = '';
        let pendingTableCount = 0;

        // --- æ¸²æŸ“å¾…ç»“ç®—åˆ—è¡¨ (è¯»å– tableOrders Map) ---
        tableOrders.forEach((orderData, tableNumber) => {
            const summary = calculateOrderSummary(orderData);
            // åªæœ‰è®¢å•é‡‘é¢å¤§äº0æˆ–æœ‰å¤‡æ³¨çš„æ¡Œå·æ‰ç®—ä½œå¾…ç»“ç®—
            if (summary.total > 0 || orderData.notes) { 
                pendingTableCount++;
                const record = { 
                    table: tableNumber, 
                    details: summary.details, 
                    total: summary.total, 
                    notes: orderData.notes || '' 
                };
                pendingOrdersListHTML += createDetailedOrderHTML(record, false);
            }
        });
        
        const pendingOrdersListContainer = document.getElementById('pendingOrdersList');
        if (pendingTableCount > 0) {
            pendingOrdersListContainer.innerHTML = pendingOrdersListHTML;
        } else {
            pendingOrdersListContainer.innerHTML = '<div class="no-pending">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œä¸­çš„è®¢å•ã€‚</div>';
        }


        // --- æ¸²æŸ“å·²ç»“ç®—åˆ—è¡¨ (è¯»å– income_data.closedOrders) ---
        let closedOrdersListHTML = '';
        const closedOrdersListContainer = document.getElementById('closedOrdersList');
        
        if (incomeData.closedOrders.length > 0) {
            // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤º (æœ€æ–°åœ¨æœ€ä¸Š)
            const reversedOrders = [...incomeData.closedOrders].reverse(); 
            reversedOrders.forEach(record => {
                // record ç»“æ„: { table, items, notes, total, timestamp }
                const normalizedRecord = {
                    table: record.table,
                    items: record.items, 
                    notes: record.notes,
                    total: record.total,
                    timestamp: record.timestamp
                };
                closedOrdersListHTML += createDetailedOrderHTML(normalizedRecord, true);
            });
            closedOrdersListContainer.innerHTML = closedOrdersListHTML;
        } else {
            closedOrdersListContainer.innerHTML = '<div class="no-pending">æš‚æ— å·²ç»“ç®—è®°å½•ã€‚</div>';
        }

        // --- æ¸²æŸ“æ±‡æ€»é¢æ¿ ---
        document.getElementById('totalIncome').textContent = incomeData.total.toLocaleString();
        document.getElementById('closedOrdersCount').textContent = incomeData.closedOrders.length;
        document.getElementById('pendingOrdersCount').textContent = pendingTableCount;
    }

    // --- ä¸šåŠ¡é€»è¾‘ (ä½¿ç”¨äº‘ç«¯ä¿å­˜) ---
    async function clearAllIncome() {
        if (confirm("è­¦å‘Šï¼æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çš„æ”¶å…¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä¸”ä¸ä¼šå½±å“å½“å‰æœªç»“ç®—çš„è®¢å•ã€‚")) {
            
            // 1. é‡ç½®æ”¶å…¥æ•°æ®
            globalCloudData.income_data = { total: 0, closedOrders: [] };
            
            // 2. åŒæ­¥åˆ°äº‘ç«¯
            const saved = await saveCloudData();
            
            if (saved) {
                renderSummary();
                alert("æ‰€æœ‰æ”¶å…¥è®°å½•å·²æ¸…ç©ºå¹¶å·²åŒæ­¥åˆ°äº‘ç«¯ã€‚");
            } else {
                // å¦‚æœä¿å­˜å¤±è´¥ï¼Œæ•°æ®ä¸ä¼šæ¸…ç©º
                alert("æ¸…ç©ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            }
        }
    }
    
    function goToOrderingPage() {
        window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        // é¡µé¢åŠ è½½æ—¶ä»äº‘ç«¯åŒæ­¥æ•°æ®
        loadCloudData();
    });
</script>

</body>

</html>
