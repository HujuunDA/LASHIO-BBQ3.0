<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹èœå•ç¨‹åº</title>
    <style>
        /* --- çƒ§çƒ¤æ©™è‰²ä¸»é¢˜ CSS ä¿®æ”¹ --- */
        /* ç§»é™¤é¡¶éƒ¨å¯¼èˆªæ ç•™ä¸‹çš„ padding */
        body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; padding-bottom: 60px; } 
        .top-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            background-color: #FF8C00; /* ä¸»è‰²ï¼šæ©™è‰² */
            color: white; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            box-sizing: border-box; 
            z-index: 10; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            /* è°ƒæ•´ top-nav å¸ƒå±€ï¼Œä»¥ä¾¿å®¹çº³å¤‡æ³¨æ¡† */
            flex-wrap: nowrap; /* é˜²æ­¢å…ƒç´ æ¢è¡Œ */
        }
        
        /* æ–°å¢: æ¡Œå·å’Œå¤‡æ³¨çš„å®¹å™¨ï¼Œç¡®ä¿å®ƒä»¬é å·¦ */
        .left-controls {
            display: flex;
            align-items: center;
            flex-grow: 1; /* å…è®¸å®ƒå æ®å‰©ä½™ç©ºé—´ï¼Œä½†é™åˆ¶å…¶å®½åº¦ */
            gap: 10px;
            overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */
        }
        
        /* ä¿®æ”¹: ç»™æ¡Œå·æ˜¾ç¤ºæ·»åŠ è¾¹æ¡† (çº¢è‰²æ¡†æ ·å¼) */
        #table-display {
            background-color: #FF4500; /* å¼ºè°ƒè‰²ï¼šæ©™çº¢è‰² */
            color: white; 
            border: 2px solid #FF4500; /* çº¢è‰²çš„è¾¹æ¡† */
            padding: 8px 10px;
            border-radius: 5px; 
            font-size: 14px; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            white-space: nowrap;
            font-weight: bold; 
        }
        
        /* æ–°å¢: å¤‡æ³¨è¾“å…¥æ¡†æ ·å¼ */
        #table-notes-input {
            flex-grow: 1; /* å æ®å‰©ä½™çš„å¤§éƒ¨åˆ†ç©ºé—´ */
            padding: 8px;
            border: 1px solid #FF4500; /* çº¢è‰²è¾¹æ¡† */
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            max-width: 300px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æŒ¤å‹å³ä¾§æŒ‰é’® */
        }

        .right-buttons {
            display: flex;
            gap: 5px; 
            flex-shrink: 0; /* é˜²æ­¢å³ä¾§æŒ‰é’®è¢«æŒ¤å‹ */
        }
        .top-nav button { 
            background-color: #FF4500; /* å¼ºè°ƒè‰²ï¼šæ©™çº¢è‰² */
            color: white; 
            border: none; 
            padding: 8px 10px;
            border-radius: 5px; 
            font-size: 14px; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            white-space: nowrap;
        }
        .category-header { 
            background-color: #FFE4B5; /* æµ…æ©™è‰²èƒŒæ™¯ */
            color: #FF4500; /* æ©™çº¢è‰²æ–‡å­— */
            padding: 15px; 
            margin-top: 0; 
            font-weight: bold; 
            font-size: 16px; 
        }
        .menu-item { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 15px 10px; border-bottom: 1px solid #eee; }
        .item-info .name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .item-info .price { font-size: 14px; color: #666; }
        .quantity-control { display: flex; align-items: center; }
        .control-btn { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            border: 1px solid #FF8C00; 
            background-color: white; 
            color: #FF8C00; 
            font-size: 20px; 
            line-height: 28px; 
            text-align: center; 
            cursor: pointer; 
            padding: 0; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); 
        }
        .control-btn.add { 
            background-color: #FF4500; 
            color: white; 
            border: none; 
        }
        .quantity { margin: 0 10px; width: 20px; text-align: center; font-size: 16px; font-weight: bold; }
        .quantity-control.hidden .minus-btn, .quantity-control.hidden .quantity { visibility: hidden; }
        .bottom-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 15px; 
            background-color: #FF8C00; 
            color: white; 
            position: fixed; 
            width: 100%; 
            bottom: 0; 
            box-sizing: border-box; 
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1); 
        }
        /* ä¿®æ”¹: è®©æŸ¥çœ‹è®¢å•æŒ‰é’®å’Œé¡¶éƒ¨æŒ‰é’®ä¿æŒä¸€è‡´çš„çº¢è‰²é£æ ¼ */
        .view-order-btn {
            background-color: #FF4500; /* å¼ºè°ƒè‰²ï¼šæ©™çº¢è‰² */
            color: white; 
            border: none; 
            padding: 10px 15px; /* ç¨å¾®å¤§ä¸€ç‚¹ï¼Œä»¥é€‚åº”åº•éƒ¨æ  */
            border-radius: 5px; 
            font-size: 16px; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            font-weight: bold;
        }
        /* Modal Styles (ä¿æŒä¸å˜) */
        .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 10px; width: 80%; max-width: 400px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: center; }
        .modal-content h2 { color: #FF4500; margin-top: 0; }
        .table-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .table-number-btn { padding: 15px 10px; background-color: #eee; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .table-number-btn.occupied { background-color: #4CAF50; color: white; border-color: #45a049; } 
        .table-number-btn.selected { background-color: #FF8C00; color: white; border-color: #FF4500; } 
        .table-number-btn.selected.occupied { background-color: #FF8C00; border-color: #FF4500; }
        .close-btn { background-color: #FF4500; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .order-modal-content { background-color: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: left; }
        .order-actions button { flex-grow: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .checkout-btn { background-color: #34c759; color: white; }
        .clear-btn { background-color: #FF8C00; color: white; }
        .close-order-btn { background-color: #ddd; color: #333; }
        
        /* èœå•åˆ—è¡¨é¡¶éƒ¨é—´è·è°ƒæ•´ */
        .menu-container { margin-top: 60px; }
        /* æ–°å¢åŠ è½½å±‚æ ·å¼ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); color: #FF8C00; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; z-index: 1000; transition: opacity 0.3s; }
    </style>
</head>
<body>
    
    <div id="loading-overlay" style="display: flex;"> æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®... ğŸš€ </div>

    <header class="top-nav">
        <div class="left-controls">
            <div id="table-display">è¯·é€‰æ‹©æ¡Œå·</div>
            <input type="text" id="table-notes-input" placeholder="è¾“å…¥å¤‡æ³¨ï¼ˆå¦‚ï¼šåŠ è¾£ï¼‰">
        </div>
        <div class="right-buttons">
            <button id="editMenuBtn">ç¼–è¾‘èœå•</button>
            <button id="incomeSummaryBtn">æ”¶å…¥æ±‡æ€»</button>
            <button id="purchaseManagerBtn">é‡‡è´­ç®¡ç†</button> 
        </div>
    </header>

    <main class="menu-container">
        </main>

    <footer class="bottom-bar">
        <div class="total-display">æ€»è®¡: <span id="totalPrice">0</span> Ks</div>
        <div class="total-display">å·²ç‚¹: <span id="orderCount">0</span> ä»½</div>
        <button class="view-order-btn" id="viewOrderBtn">æŸ¥çœ‹è®¢å•</button>
    </footer>

    <div id="tableModal" class="modal">
        <div class="modal-content">
            <h2>è¯·é€‰æ‹©æ¡Œå·</h2>
            <div id="tableGrid" class="table-grid">
                </div>
            <button id="closeModalBtn" class="close-btn">å…³é—­</button>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="order-modal-content">
            <div class="order-header">
                <div class="order-title" id="orderModalTitle">æ¡Œå·: N/A</div>
            </div>
            <div id="orderModalNotes" style="font-style: italic; color: #FF4500; margin-bottom: 10px;"></div>
            <div class="order-hr"></div>
            <div class="order-content" id="orderDetailsContent">
            </div>
            <div class="order-hr"></div>
            <div class="order-total-display" id="orderModalTotal">æ€»é¢: 0 Ks</div>
            <div class="order-actions">
                <button class="checkout-btn" id="checkoutBtn">ç»“ç®— (â‚¬)</button>
                <button class="clear-btn" id="clearOrderBtn">æ¸…ç©ºè®¢å•</button>
                <button class="close-order-btn" id="orderCloseBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // --- Cloud Sync Configuration (å·²æ›´æ–°ä¸ºæ‚¨æä¾›çš„æ–°ä¿¡æ¯) ---
        const JSONBIN_ID = '69174442ae596e708f5901ae'; 
        const JSONBIN_MASTER_KEY = '$2a$10$ol9N5tLV0G2AnDYaF4sO4O2l0RoR8OSXagA4IUy2wiwdntZDuzRh2';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

        let globalCloudData = {
            menu_data: [],
            table_orders: {}, 
            income_data: { total: 0, closedOrders: [] },
            purchase_data: { productTemplate: {}, cartData: [] }
        };
        
        let menuItems = [];
        // ä¿®æ”¹ tableOrders å­˜å‚¨ç»“æ„ä¸º Map<String: tableNumber, Object: { items: Array, notes: String }>
        let tableOrders = new Map(); 

        // --- Cloud Utilities ---
        async function loadCloudData() {
            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Cloud fetch failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.record) {
                    globalCloudData = data.record;
                    // ç¡®ä¿æ‰€æœ‰é¡¶å±‚å±æ€§éƒ½å­˜åœ¨
                    if (!globalCloudData.menu_data) globalCloudData.menu_data = [];
                    if (!globalCloudData.table_orders) globalCloudData.table_orders = {};
                    if (!globalCloudData.income_data) globalCloudData.income_data = { total: 0, closedOrders: [] };
                    if (!globalCloudData.purchase_data) globalCloudData.purchase_data = { productTemplate: {}, cartData: [] };

                    menuItems = globalCloudData.menu_data;
                    
                    // é€‚é…æ–°çš„ tableOrders ç»“æ„ (å…¼å®¹æ—§çš„åªå­˜æ•°ç»„çš„ç»“æ„)
                    tableOrders = new Map();
                    for (const [tableNum, orderData] of Object.entries(globalCloudData.table_orders)) {
                        if (Array.isArray(orderData)) {
                             // å¦‚æœæ˜¯æ—§çš„æ•°ç»„ç»“æ„ï¼Œè½¬æ¢ä¸ºæ–°å¯¹è±¡
                             tableOrders.set(tableNum, { items: orderData, notes: '' });
                        } else {
                            // ç¡®ä¿ items å’Œ notes å­˜åœ¨
                            if (!orderData.items) orderData.items = [];
                            if (typeof orderData.notes !== 'string') orderData.notes = '';
                            tableOrders.set(tableNum, orderData);
                        }
                    }
                    console.log("æ•°æ®ä»äº‘ç«¯åŠ è½½æˆåŠŸã€‚", globalCloudData);
                } else {
                    console.warn("äº‘ç«¯æ•°æ®ç»“æ„ä¸å®Œæ•´æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ç»“æ„ã€‚", data);
                }
            } catch (error) {
                console.error("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤æ•°æ®ã€‚", error);
                alert("äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
            }
        }

        async function saveCloudData() {
            globalCloudData.menu_data = menuItems;
            
            // è½¬æ¢ tableOrders Map ä¸º Object ä»¥ä¾¿ä¿å­˜
            const storableTableOrders = {};
            for (const [tableNum, data] of tableOrders.entries()) {
                // åªä¿å­˜æœ‰è®¢å•é¡¹æˆ–æœ‰å¤‡æ³¨çš„æ¡Œå·
                if (data.items.length > 0 || data.notes) {
                    storableTableOrders[tableNum] = data;
                }
            }
            globalCloudData.table_orders = storableTableOrders;

            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT', // ä½¿ç”¨ PUT æ›´æ–°æ•´ä¸ª Bin
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(globalCloudData)
                });

                if (!response.ok) {
                    throw new Error(`Cloud save failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log("æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚", result);
                return true;
            } catch (error) {
                console.error("ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ã€‚", error);
                alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
                return false;
            }
        }
        
        // --- æ ¸å¿ƒé€»è¾‘ ---
        const totalTableCount = 12;
        const menuContainer = document.querySelector('.menu-container');
        const totalPriceElement = document.getElementById('totalPrice');
        const orderCountElement = document.getElementById('orderCount');
        const tableModal = document.getElementById('tableModal');
        const orderModal = document.getElementById('orderModal');
        const tableDisplay = document.getElementById('table-display');
        const tableNotesInput = document.getElementById('table-notes-input'); // è·å–å¤‡æ³¨è¾“å…¥æ¡†
        let currentTableNumber = null;
        
        // ä¿®æ”¹: æ‰¾åˆ°å½“å‰æ¡Œå·è®¢å•é¡¹çš„è¾…åŠ©å‡½æ•°
        function findItemInCurrentOrder(id) {
            if (!currentTableNumber || !tableOrders.has(currentTableNumber)) return null;
            return tableOrders.get(currentTableNumber).items.find(item => item.id === id);
        }
        
        // ä¿®æ”¹: è®¡ç®—æ€»ä»·å’Œæ€»ä»½æ•°
        function calculateOrderTotal(orderData) { return orderData.items.reduce((total, item) => total + (item.price * item.quantity), 0); }
        function calculateOrderCount(orderData) { return orderData.items.reduce((count, item) => count + item.quantity, 0); }
        
        function getLatestMenuStructure() {
            const latestMenu = globalCloudData.menu_data || [];
            const categories = [...new Set(latestMenu.map(item => item.category))];
            
            return { latestMenu, categories };
        }
        
        // ä¿®æ”¹: åˆ‡æ¢æ¡Œå·é€»è¾‘
        function selectNewTable(tableNumber) {
            currentTableNumber = tableNumber;
            tableDisplay.textContent = `å½“å‰æ¡Œå·: ${tableNumber}`;
            
            if (!tableOrders.has(tableNumber)) {
                // åˆå§‹åŒ–æ–°æ¡Œå·çš„è®¢å•ç»“æ„
                tableOrders.set(tableNumber, { items: [], notes: '' }); 
            }
            
            const currentOrderData = tableOrders.get(tableNumber);
            // åŠ è½½å½“å‰æ¡Œå·çš„å¤‡æ³¨
            tableNotesInput.value = currentOrderData.notes;
            
            renderMenu();
            updateTotals();
            updateTableStatus();
            hideModal(tableModal);
        }

        // ä¿®æ”¹: æ¸²æŸ“æ¡Œå·ç½‘æ ¼ (åˆ¤æ–­æ˜¯å¦å ç”¨ç°åœ¨éœ€è¦æ£€æŸ¥ items æ•°ç»„)
        function renderTableGrid() {
            const tableGrid = document.getElementById('tableGrid');
            tableGrid.innerHTML = '';
            
            for (let i = 1; i <= totalTableCount; i++) {
                const tableNum = String(i);
                // åˆ¤æ–­æ˜¯å¦å ç”¨ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è®¢å•é¡¹
                const isOccupied = tableOrders.has(tableNum) && tableOrders.get(tableNum).items.length > 0;
                const isSelected = tableNum === currentTableNumber;
                
                const button = document.createElement('button');
                button.textContent = `æ¡Œå· ${i}`;
                button.className = 'table-number-btn';
                if (isOccupied) {
                    button.classList.add('occupied');
                }
                if (isSelected) {
                    button.classList.add('selected');
                }
                
                button.onclick = () => selectNewTable(tableNum);
                tableGrid.appendChild(button);
            }
        }
        
        function renderMenu() {
            const { latestMenu, categories } = getLatestMenuStructure();
            menuContainer.innerHTML = '';
            
            if (latestMenu.length === 0) {
                menuContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">èœå•ä¸ºç©ºï¼Œè¯·å…ˆåœ¨ "ç¼–è¾‘èœå•" ä¸­æ·»åŠ èœå“ã€‚</p>';
                return;
            }

            categories.forEach(category => {
                const header = document.createElement('h3');
                header.className = 'category-header';
                header.textContent = category;
                menuContainer.appendChild(header);

                const items = latestMenu.filter(item => item.category === category);
                items.forEach(item => {
                    const orderItem = findItemInCurrentOrder(item.id);
                    const quantity = orderItem ? orderItem.quantity : 0;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'menu-item';
                    itemDiv.innerHTML = `
                        <div class="item-info">
                            <div class="name">${item.name}</div>
                            <div class="price">${item.price.toLocaleString()} Ks</div>
                        </div>
                        <div class="quantity-control ${quantity === 0 ? 'hidden' : ''}" data-id="${item.id}">
                            <button class="control-btn minus-btn" data-id="${item.id}">-</button>
                            <span class="quantity">${quantity}</span>
                            <button class="control-btn add add-btn" data-id="${item.id}">+</button>
                        </div>
                    `;
                    menuContainer.appendChild(itemDiv);
                });
            });
            bindMenuButtons();
        }

        function bindMenuButtons() {
            document.querySelectorAll('.control-btn').forEach(button => {
                button.onclick = async (e) => {
                    if (currentTableNumber === null) {
                        alert('è¯·å…ˆé€‰æ‹©æ¡Œå·ï¼');
                        renderTableGrid();
                        showModal(tableModal);
                        return;
                    }
                    
                    const id = e.target.getAttribute('data-id');
                    const change = e.target.classList.contains('add') ? 1 : -1;
                    await updateQuantity(id, change);
                };
            });
        }

        // ä¿®æ”¹: æ›´æ–°æ•°é‡é€»è¾‘
        async function updateQuantity(id, change) {
            const currentOrderData = tableOrders.get(currentTableNumber);
            let currentItems = currentOrderData.items; // è·å– items æ•°ç»„
            const menu = getLatestMenuStructure().latestMenu;
            const itemDetails = menu.find(item => item.id === id);
            
            if (!itemDetails) return;

            let orderItem = currentItems.find(item => item.id === id);

            if (orderItem) {
                orderItem.quantity += change;
                if (orderItem.quantity <= 0) {
                    currentItems = currentItems.filter(item => item.id !== id);
                    currentOrderData.items = currentItems; // æ›´æ–°å› orderData
                }
            } else if (change > 0) {
                currentItems.push({
                    id: itemDetails.id,
                    name: itemDetails.name,
                    price: itemDetails.price,
                    quantity: 1
                });
            }
            
            // å¦‚æœè®¢å•ä¸ºç©ºä¸”å¤‡æ³¨ä¸ºç©ºï¼Œåˆ™ç§»é™¤è¯¥æ¡Œå·è®°å½•
            if (currentItems.length === 0 && !currentOrderData.notes) {
                tableOrders.delete(currentTableNumber);
            }
            
            await saveCloudData();
            renderMenu(); 
            updateTotals();
            updateTableStatus();
        }

        // ä¿®æ”¹: æ›´æ–°æ€»è®¡é€»è¾‘
        function updateTotals() {
            const currentOrderData = currentTableNumber ? tableOrders.get(currentTableNumber) || { items: [] } : { items: [] };
            const total = calculateOrderTotal(currentOrderData);
            const count = calculateOrderCount(currentOrderData);
            
            totalPriceElement.textContent = total.toLocaleString();
            orderCountElement.textContent = count.toLocaleString();
        }

        // ä¿®æ”¹: æ›´æ–°æ¡Œå·çŠ¶æ€ (æ£€æŸ¥ items æ•°ç»„)
        function updateTableStatus() {
            const tableButton = document.querySelector(`.table-number-btn[onclick*="'${currentTableNumber}'"]`);
            if (tableButton) {
                const isOccupied = tableOrders.has(currentTableNumber) && tableOrders.get(currentTableNumber).items.length > 0;
                tableButton.classList.toggle('occupied', isOccupied);
            }
        }
        
        // ä¿®æ”¹: æ¸²æŸ“è®¢å•è¯¦æƒ…é€»è¾‘ (æ–°å¢æ˜¾ç¤ºå¤‡æ³¨)
        function renderOrderDetails() {
            const currentOrderData = tableOrders.get(currentTableNumber) || { items: [], notes: '' };
            const currentItems = currentOrderData.items;
            const detailsContent = document.getElementById('orderDetailsContent');
            const totalDisplay = document.getElementById('orderModalTotal');
            const title = document.getElementById('orderModalTitle');
            const notesDisplay = document.getElementById('orderModalNotes'); // è·å–å¤‡æ³¨æ˜¾ç¤ºå…ƒç´ 

            title.textContent = `æ¡Œå·: ${currentTableNumber} - è®¢å•è¯¦æƒ…`;
            notesDisplay.textContent = currentOrderData.notes ? `å¤‡æ³¨: ${currentOrderData.notes}` : '';
            
            if (currentItems.length === 0) {
                detailsContent.innerHTML = '<p style="text-align: center; color: #666;">å½“å‰è®¢å•ä¸ºç©ºã€‚</p>';
                totalDisplay.textContent = 'æ€»é¢: 0 Ks';
                showModal(orderModal);
                return;
            }

            let html = '<ul style="list-style-type: none; padding: 0;">';
            currentItems.forEach(item => {
                html += `
                    <li style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee;">
                        <span style="font-weight: bold;">${item.name}</span>
                        <span style="flex-grow: 1; text-align: center;">x ${item.quantity}</span>
                        <span>${(item.price * item.quantity).toLocaleString()} Ks</span>
                    </li>
                `;
            });
            html += '</ul>';
            
            detailsContent.innerHTML = html;
            totalDisplay.textContent = `æ€»é¢: ${calculateOrderTotal(currentOrderData).toLocaleString()} Ks`;
            
            showModal(orderModal);
        }

        // ä¿®æ”¹: ç»“ç®—é€»è¾‘ (å°†å¤‡æ³¨å­˜å…¥ income_data)
        async function checkoutAndSaveIncome() {
            if (confirm(`ç¡®å®šç»“ç®—æ¡Œå· ${currentTableNumber} çš„è®¢å•å—ï¼Ÿ`)) {
                const currentOrderData = tableOrders.get(currentTableNumber) || { items: [], notes: '' };
                const currentItems = currentOrderData.items;

                if (currentItems.length === 0) {
                    alert('è®¢å•ä¸ºç©ºï¼Œæ— éœ€ç»“ç®—ã€‚');
                    hideModal(orderModal);
                    return;
                }
                
                const total = calculateOrderTotal(currentOrderData);
                const closedRecord = {
                    table: currentTableNumber,
                    items: JSON.parse(JSON.stringify(currentItems)), 
                    notes: currentOrderData.notes, // æ–°å¢å¤‡æ³¨
                    total: total,
                    timestamp: new Date().toISOString()
                };

                // 1. æ›´æ–°æ”¶å…¥æ•°æ®
                globalCloudData.income_data.total += total;
                globalCloudData.income_data.closedOrders.push(closedRecord);
                
                // 2. æ¸…ç©ºå½“å‰æ¡Œçš„è®¢å•å’Œå¤‡æ³¨
                tableOrders.delete(currentTableNumber);
                tableNotesInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                
                // 3. åŒæ­¥åˆ°äº‘ç«¯
                const saved = await saveCloudData();

                if (saved) {
                    alert(`æ¡Œå· ${currentTableNumber} ç»“ç®—æˆåŠŸï¼æ”¶å…¥: ${total.toLocaleString()} Ks`);
                    hideModal(orderModal);
                    renderMenu();
                    updateTotals();
                    renderTableGrid(); 
                }
            }
        }

        // ä¿®æ”¹: æ¸…ç©ºè®¢å•é€»è¾‘ (æ¸…ç©º items å’Œ notes)
        async function resetOrder() {
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ¡Œå· ${currentTableNumber} çš„è®¢å•å’Œå¤‡æ³¨å—ï¼Ÿ`)) {
                
                // æ¸…ç©ºå½“å‰æ¡Œçš„è®¢å•å’Œå¤‡æ³¨
                tableOrders.delete(currentTableNumber);
                tableNotesInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

                // åŒæ­¥åˆ°äº‘ç«¯
                const saved = await saveCloudData();

                if (saved) {
                    alert(`æ¡Œå· ${currentTableNumber} çš„è®¢å•å·²æ¸…ç©ºã€‚`);
                    hideModal(orderModal);
                    renderMenu();
                    updateTotals();
                    renderTableGrid(); 
                }
            }
        }
        
        function showModal(modalElement) { modalElement.style.display = 'flex'; }
        function hideModal(modalElement) { modalElement.style.display = 'none'; }


        // --- äº‹ä»¶ç»‘å®šå’Œåˆå§‹åŒ– ---
        function bindEventListeners() {
            // FIX: å¯¼èˆªå…¥å£æ”¹ä¸ºæ­£ç¡®çš„é“¾æ¥
            document.getElementById('editMenuBtn').onclick = () => window.location.href = 'edit_menu.html';
            document.getElementById('incomeSummaryBtn').onclick = () => window.location.href = 'income_summary.html';
            document.getElementById('purchaseManagerBtn').onclick = () => window.location.href = '16.36.html';

            // å¤‡æ³¨æ¡†è¾“å…¥äº‹ä»¶
            tableNotesInput.addEventListener('input', async () => {
                if (currentTableNumber === null) {
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ¡Œå·ï¼Œåˆ™ä¸å¤„ç†è¾“å…¥
                    tableNotesInput.value = '';
                    return;
                }
                
                const currentOrderData = tableOrders.get(currentTableNumber);
                currentOrderData.notes = tableNotesInput.value.trim();
                
                // å¦‚æœç”¨æˆ·è¾“å…¥äº†å¤‡æ³¨ï¼Œä½†å½“å‰æ¡Œå·çš„è®°å½•è¢«ç§»é™¤äº†ï¼ˆä¾‹å¦‚æ¸…ç©ºï¼‰ï¼Œéœ€è¦é‡æ–°åˆ›å»ºä¸€ä¸ªåŸºç¡€ç»“æ„
                if (!tableOrders.has(currentTableNumber)) {
                    // é‡æ–°åˆ›å»ºè®°å½•ä»¥ä¿å­˜å¤‡æ³¨
                    tableOrders.set(currentTableNumber, { items: [], notes: currentOrderData.notes });
                }

                // å®æ—¶åŒæ­¥å¤‡æ³¨
                await saveCloudData(); 
                renderTableGrid();
            });


            // æ¨¡æ€æ¡†å’Œæ ¸å¿ƒäº¤äº’ (ä¿æŒä¸å˜)
            document.getElementById('table-display').onclick = () => {
                renderTableGrid();
                showModal(tableModal);
            };

            document.getElementById('viewOrderBtn').onclick = () => {
                if (currentTableNumber === null) {
                    alert('è¯·å…ˆé€‰æ‹©æ¡Œå·ï¼');
                    renderTableGrid();
                    showModal(tableModal);
                    return;
                }
                renderOrderDetails();
            };

            document.getElementById('checkoutBtn').onclick = checkoutAndSaveIncome;
            document.getElementById('clearOrderBtn').onclick = resetOrder;
            document.getElementById('orderCloseBtn').onclick = () => hideModal(orderModal);
            document.getElementById('closeModalBtn').onclick = () => hideModal(tableModal);
            
            window.onclick = function(event) {
                if (event.target == tableModal) {
                    hideModal(tableModal);
                }
                if (event.target == orderModal) {
                    hideModal(orderModal);
                }
            }
        }
        
        // é¡µé¢å¯åŠ¨
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCloudData();
            document.getElementById('loading-overlay').style.display = 'none';
            renderMenu();
            bindEventListeners();
            renderTableGrid();
            
            // é»˜è®¤é€‰æ‹©æ¡Œå· 1
            selectNewTable('1');
        });
    </script>
</body>
</html>
