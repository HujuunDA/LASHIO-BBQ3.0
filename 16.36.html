<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é‡‡è´­ç®¡ç† (Ks) - äº‘åŒæ­¥ç‰ˆ</title>
    <style>
        /* 1. å…¨å±€å’Œå­—ä½“è®¾ç½® (Clear and Minimal) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f7f7f7; /* æµ…ç°è‰²èƒŒæ™¯ */
            color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
            padding-top: 0; 
        }
        
        /* ğŸŒŸ å¤´éƒ¨å¯¼èˆªæ æ ·å¼ (è¿˜åŸè“è‰² - ä¿æŒåŸç‰ˆé¢œè‰²) */
        .header-bar {
            background-color: #007aff; /* è“è‰² */
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px; 
            border-radius: 0 0 16px 16px; 
            position: sticky;
            top: 0; 
            z-index: 99;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header-bar h1 {
            margin: 0;
            font-size: 24px;
            color: white;
        }
        /* æ–°å¢ï¼šè¿”å›ç‚¹å•æŒ‰é’® */
        .back-button {
            background-color: #ff3b30; /* çº¢è‰² */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }
        
        /* 2. ä¸»è¦å¸ƒå±€å’Œå®¹å™¨ */
        .container { max-width: 900px; margin: 30px auto; background: #ffffff; padding: 30px; border-radius: 16px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); }

        /* 3. Tab æ§ä»¶æ ·å¼ */
        .tabs { display: flex; background-color: #f0f0f0; border-radius: 10px; padding: 4px; margin-bottom: 30px; }
        .tab-button { flex-grow: 1; padding: 10px 15px; border: none; background: none; font-size: 15px; font-weight: 600; color: #8e8e93; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .tab-button.active { background-color: #ffffff; color: #1c1c1e; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .tab-content { display: none; padding: 10px 0; }
        .tab-content.active { display: block; }

        /* 4. æ¨¡æ¿åˆ—è¡¨/å•†å“åˆ—è¡¨æ ·å¼ */
        .category-container { margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; }
        .category-header { background-color: #f0f0f0; padding: 10px 15px; font-weight: 700; color: #007aff; border-bottom: 1px solid #e0e0e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .category-header span { font-size: 14px; color: #8e8e93; font-weight: 500;}
        .product-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .product-item:last-child { border-bottom: none; }
        .product-item .name { font-size: 16px; font-weight: 500; }
        .product-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: #007aff; }

        /* 5. è´­ç‰©è½¦/æ¸…å•æ ·å¼ */
        #cart-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #cart-table th, #cart-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        #cart-table th { background-color: #f0f0f0; font-weight: 700; color: #4a4a4f; }
        #cart-table tr:last-child td { border-bottom: none; }
        .cart-item-name { cursor: pointer; font-weight: 500; }
        .cart-item-name.purchased { text-decoration: line-through; color: #8e8e93; }
        .cart-item-price-input { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-size: 15px; }
        #cart-total-display { text-align: right; font-size: 1.5em; font-weight: 700; margin-top: 20px; color: #34c759; }

        /* 6. åº•éƒ¨æ§åˆ¶å’Œæ¨¡æ¿ç®¡ç† */
        .checkout-bar { text-align: center; margin-top: 30px; }
        .checkout-bar button { background-color: #34c759; color: white; border: none; padding: 14px 40px; font-size: 17px; font-weight: 600; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3); transition: all 0.2s; }

        .add-new-control { display: flex; gap: 10px; margin-top: 20px; }
        .add-new-control input, .add-new-control select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; flex-grow: 1; }
        .add-new-control button { width: 100px; background-color: #007aff; color: white; border: none; padding: 10px 0; cursor: pointer; flex-shrink: 0; font-weight: 600; border-radius: 8px; }

        .template-actions { display: flex; gap: 5px; }
        .template-actions button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; }
        .template-actions .delete-btn { background-color: #ff3b30; color: white; }
        .template-actions .edit-btn { background-color: #ffcc00; color: #1c1c1e; }

        .copy-button { background-color: #007aff; color: white; border: none; padding: 12px 25px; font-size: 16px; font-weight: 600; border-radius: 12px; cursor: pointer; margin-top: 20px; margin-bottom: 10px; }
        .reset-button { background-color: #ff3b30; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-weight: 600; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); color: #007aff; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: 600; z-index: 1000; transition: opacity 0.3s; }
    </style>
</head>
<body>
    
    <div id="loading-overlay" style="display: flex;"> æ­£åœ¨ä»äº‘ç«¯åŠ è½½é‡‡è´­æ¸…å•... ğŸš€ </div>

    <div class="header-bar">
        <h1>ğŸ›’ é«˜çº§é‡‡è´­ç®¡ç† (Ks)</h1>
        <button class="back-button" onclick="goToOrderingPage()">è¿”å›ç‚¹å•</button> 
    </div>

    <div class="container">
        
        <div class="tabs" id="tab-controls">
            <button class="tab-button active" onclick="openTab(event, 'product-list')">ğŸ›’ é€‰æ‹©é‡‡è´­é¡¹</button>
            <button class="tab-button" onclick="openTab(event, 'cart')">ğŸ“ é‡‡è´­æ¸…å• (å¾…å®Œæˆ)</button>
            <button class="tab-button" onclick="openTab(event, 'product-template')">âš™ï¸ ç®¡ç†é‡‡è´­æ¨¡æ¿</button>
        </div>

        <div id="product-list" class="tab-content active">
            <div id="product-list-container">
                </div>
            
            <div class="checkout-bar">
                <button onclick="addSelectedToCart()">â• æ·»åŠ åˆ°é‡‡è´­æ¸…å•</button>
            </div>
        </div>

        <div id="cart" class="tab-content">
            <h2>é‡‡è´­æ¸…å•</h2>
            <table id="cart-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">é¡¹ç›® (ç‚¹å‡»æ¸…ç©ºä»·æ ¼)</th>
                        <th style="text-align: right; width: 30%;">æ•°é‡/å•ä½</th>
                        <th style="text-align: right; width: 20%;">ä»·æ ¼ (Ks)</th>
                    </tr>
                </thead>
                <tbody id="cart-table-body">
                </tbody>
            </table>
            
            <div id="cart-total-display">æ€»è®¡: 0 Ks</div>
            
            <div class="checkout-bar" style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                <button class="copy-button" onclick="copyCartSummary()">ğŸ“‹ å¤åˆ¶æ¸…å•æ€»ç»“</button>
                <button class="reset-button" onclick="resetCart()">ğŸ—‘ï¸ æ¸…ç©ºå·²å®Œæˆé¡¹ç›®</button>
            </div>
        </div>
        
        <div id="product-template" class="tab-content">
            <h2>ç®¡ç†é‡‡è´­æ¨¡æ¿</h2>
            <div id="template-list">
                </div>

            <div class="add-new-control">
                <input type="text" id="newProductName" placeholder="æ–°çš„é‡‡è´­é¡¹åç§°" required>
                <select id="newProductCategory">
                    </select>
                <button onclick="addProductTemplate()">æ·»åŠ </button>
            </div>
            
        </div>

    </div>
    
    <script>
        // --- Cloud Sync Configuration (å·²æ›´æ–°ä¸ºæ‚¨æä¾›çš„æ–°ä¿¡æ¯) ---
        const JSONBIN_ID = '69174442ae596e708f5901ae'; 
        const JSONBIN_MASTER_KEY = '$2a$10$ol9N5tLV0G2AnDYaF4sO4O2l0RoR8OSXagA4IUy2wiwdntZDuzRh2';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

        const CURRENCY_SUFFIX = ' Ks';
        const templateListContainer = document.getElementById('template-list');
        const cartTableBody = document.getElementById('cart-table-body');
        const productListContainer = document.getElementById('product-list-container');
        const categorySelect = document.getElementById('newProductCategory');
        const newProductNameInput = document.getElementById('newProductName');

        let globalCloudData = {
            menu_data: [],
            table_orders: {}, 
            income_data: { total: 0, closedOrders: [] },
            purchase_data: { productTemplate: {}, cartData: [] } // é»˜è®¤ç»“æ„
        };
        let cloudData = globalCloudData.purchase_data; 
        
        // --- Cloud Utilities ---
        async function loadCloudData() {
            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`Cloud fetch failed: ${response.statusText}`);
                const data = await response.json();
                if (data.record) {
                    globalCloudData = data.record;
                    if (!globalCloudData.purchase_data) globalCloudData.purchase_data = { productTemplate: {}, cartData: [] };
                    cloudData = globalCloudData.purchase_data;
                }
            } catch (error) {
                console.error("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤æ•°æ®ã€‚", error);
                alert("äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
            }
        }

        async function saveProductsToCloud() {
            globalCloudData.purchase_data = cloudData;
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(globalCloudData)
                });
                if (!response.ok) throw new Error(`Cloud save failed: ${response.statusText}`);
                console.log("é‡‡è´­æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚");
                return true;
            } catch (error) {
                console.error("ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ã€‚", error);
                alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æˆ–ç½‘ç»œã€‚");
                return false;
            }
        }
        
        // --- æ ¸å¿ƒé‡‡è´­æ¨¡æ¿ç®¡ç† (Tab 3) ---
        function renderProductTemplate() {
            templateListContainer.innerHTML = '';
            const categories = Object.keys(cloudData.productTemplate).sort();

            if (categories.length === 0) {
                templateListContainer.innerHTML = '<p style="text-align: center; color: #8e8e93; padding: 30px;">æš‚æ— é‡‡è´­æ¨¡æ¿ï¼Œè¯·æ·»åŠ ã€‚</p>';
                return;
            }

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-container';
                categoryDiv.innerHTML = `<div class="category-header">${category}</div>`;
                
                cloudData.productTemplate[category].forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <span class="name">${product}</span>
                        <div class="template-actions">
                            <button class="delete-btn" onclick="deleteProductTemplate('${category}', '${product}')">åˆ é™¤</button>
                        </div>
                    `;
                    categoryDiv.appendChild(productItem);
                });
                templateListContainer.appendChild(categoryDiv);
            });
            renderCategorySelect();
        }

        function renderCategorySelect() {
            const categories = Object.keys(cloudData.productTemplate).sort();
            categorySelect.innerHTML = '<option value="">-- é€‰æ‹©åˆ†ç±» --</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            categorySelect.innerHTML += '<option value="new_category">â• æ–°å¢åˆ†ç±»...</option>';

            categorySelect.onchange = function() {
                if (this.value === 'new_category') {
                    const newCat = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:');
                    if (newCat) {
                        const newOpt = document.createElement('option');
                        newOpt.value = newCat;
                        newOpt.textContent = newCat;
                        categorySelect.insertBefore(newOpt, categorySelect.lastChild);
                        categorySelect.value = newCat;
                    } else {
                        categorySelect.value = '';
                    }
                }
            };
        }

        async function addProductTemplate() {
            const name = newProductNameInput.value.trim();
            let category = categorySelect.value;
            
            if (!name) { alert('è¯·è¾“å…¥é‡‡è´­é¡¹åç§°ã€‚'); return; }
            if (!category) { alert('è¯·é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±»ã€‚'); return; }

            if (category === 'new_category') {
                category = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:');
                if (!category) return;
            }

            if (!cloudData.productTemplate[category]) {
                cloudData.productTemplate[category] = [];
            }
            
            // é¿å…é‡å¤
            if (cloudData.productTemplate[category].includes(name)) {
                alert(`"${name}" å·²ç»åœ¨ "${category}" åˆ†ç±»ä¸­ã€‚`);
                return;
            }

            cloudData.productTemplate[category].push(name);
            cloudData.productTemplate[category].sort();
            
            const saved = await saveProductsToCloud();
            if (saved) {
                newProductNameInput.value = '';
                categorySelect.value = '';
                renderProductTemplate();
            }
        }

        async function deleteProductTemplate(category, product) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é‡‡è´­æ¨¡æ¿ "${product}" å—ï¼Ÿ`)) {
                cloudData.productTemplate[category] = cloudData.productTemplate[category].filter(p => p !== product);
                
                // å¦‚æœåˆ†ç±»ä¸‹æ²¡æœ‰é¡¹ç›®äº†ï¼Œåˆ™åˆ é™¤åˆ†ç±»
                if (cloudData.productTemplate[category].length === 0) {
                    delete cloudData.productTemplate[category];
                }
                
                const saved = await saveProductsToCloud();
                if (saved) {
                    renderProductTemplate();
                }
            }
        }
        
        // --- é‡‡è´­é€‰æ‹©åˆ—è¡¨ (Tab 1) ---
        function renderProductList() {
            productListContainer.innerHTML = '';
            const categories = Object.keys(cloudData.productTemplate).sort();
            const existingCartNames = cloudData.cartData.map(item => item.name);

            if (categories.length === 0) {
                productListContainer.innerHTML = '<p style="text-align: center; color: #8e8e93; padding: 30px;">è¯·å…ˆåœ¨â€œç®¡ç†é‡‡è´­æ¨¡æ¿â€ä¸­æ·»åŠ é¡¹ç›®ã€‚</p>';
                return;
            }

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-container';
                categoryDiv.innerHTML = `<div class="category-header">${category} <span>(${cloudData.productTemplate[category].length} é¡¹)</span></div><div class="product-group"></div>`;
                const productGroup = categoryDiv.querySelector('.product-group');
                
                cloudData.productTemplate[category].forEach(productName => {
                    // åªæœ‰è´­ç‰©è½¦ä¸­æ²¡æœ‰çš„é¡¹ç›®æ‰èƒ½è¢«é€‰ä¸­
                    const isDisabled = existingCartNames.includes(productName);
                    
                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <label>
                            <input type="checkbox" data-name="${productName}" ${isDisabled ? 'disabled' : ''}>
                            <span class="${isDisabled ? 'disabled-text' : ''}">${productName}</span>
                        </label>
                        <input type="number" min="1" data-name="${productName}" class="product-quantity" placeholder="æ•°é‡" style="width: 60px; text-align: right;">
                    `;
                    productGroup.appendChild(productItem);
                });
                productListContainer.appendChild(categoryDiv);
            });
        }

        async function addSelectedToCart() {
            const selectedItems = [];
            document.querySelectorAll('#product-list-container input[type="checkbox"]:checked').forEach(checkbox => {
                const name = checkbox.getAttribute('data-name');
                const quantityInput = document.querySelector(`.product-quantity[data-name="${name}"]`);
                let quantity = parseInt(quantityInput.value, 10);
                
                if (isNaN(quantity) || quantity <= 0) {
                    quantity = 1; // é»˜è®¤æ•°é‡ä¸º 1
                }
                
                selectedItems.push({
                    name: name,
                    price: 0,
                    quantity: quantity,
                    purchased: false
                });
            });

            if (selectedItems.length === 0) {
                alert('è¯·é€‰æ‹©è¦æ·»åŠ åˆ°é‡‡è´­æ¸…å•çš„é¡¹ç›®ã€‚');
                return;
            }

            cloudData.cartData = cloudData.cartData.concat(selectedItems);
            
            const saved = await saveProductsToCloud();
            if (saved) {
                alert(`${selectedItems.length} ä¸ªé¡¹ç›®å·²æ·»åŠ åˆ°é‡‡è´­æ¸…å•!`);
                renderProductList();
                // è‡ªåŠ¨åˆ‡æ¢åˆ°è´­ç‰©è½¦
                openTab(null, 'cart'); 
            }
        }
        
        // --- é‡‡è´­æ¸…å•/è´­ç‰©è½¦ (Tab 2) ---
        function renderCart() {
            cartTableBody.innerHTML = '';
            let grandTotalCost = 0;

            if (cloudData.cartData.length === 0) {
                cartTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #8e8e93;">é‡‡è´­æ¸…å•ä¸ºç©ºã€‚</td></tr>';
                document.getElementById('cart-total-display').textContent = `æ€»è®¡: 0${CURRENCY_SUFFIX}`;
                return;
            }

            cloudData.cartData.forEach((item, index) => {
                const row = cartTableBody.insertRow();
                row.className = item.purchased ? 'purchased-row' : '';
                
                // Item Name (Cell 1)
                const nameCell = row.insertCell();
                nameCell.className = `cart-item-name ${item.purchased ? 'purchased' : ''}`;
                nameCell.textContent = item.name;
                nameCell.onclick = () => clearPrice(index); // ç‚¹å‡»æ¸…ç©ºä»·æ ¼/æ ‡è®°æœªè´­ä¹°
                
                // Quantity (Cell 2)
                const quantityCell = row.insertCell();
                quantityCell.style.textAlign = 'right';
                quantityCell.textContent = `x ${item.quantity}`;
                
                // Price Input (Cell 3)
                const priceCell = row.insertCell();
                priceCell.style.textAlign = 'right';
                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.min = '0';
                priceInput.value = item.price || '';
                priceInput.className = 'cart-item-price-input';
                priceInput.onchange = (e) => updateCartItem(index, parseInt(e.target.value, 10));
                priceCell.appendChild(priceInput);

                // Checkbox to mark as purchased
                const purchasedCheckbox = document.createElement('input');
                purchasedCheckbox.type = 'checkbox';
                purchasedCheckbox.checked = item.purchased;
                purchasedCheckbox.onchange = (e) => updatePurchasedStatus(index, e.target.checked);
                
                const checkboxLabel = document.createElement('label');
                checkboxLabel.style.display = 'flex';
                checkboxLabel.style.alignItems = 'center';
                checkboxLabel.style.justifyContent = 'flex-start';
                checkboxLabel.style.gap = '8px';
                checkboxLabel.appendChild(purchasedCheckbox);
                checkboxLabel.appendChild(document.createTextNode('å·²è´­'));
                
                // å°†å¤é€‰æ¡†æ·»åŠ åˆ° nameCell å‰ï¼Œç¡®ä¿äº¤äº’ä¸å˜ä½†æ˜¾ç¤ºä¼˜åŒ–
                nameCell.style.display = 'flex';
                nameCell.style.alignItems = 'center';
                nameCell.style.gap = '10px';
                nameCell.insertBefore(purchasedCheckbox, nameCell.firstChild);

                // è®¡ç®—æ€»ä»·
                if (item.purchased && item.price > 0) {
                    grandTotalCost += item.price * item.quantity;
                }
            });

            document.getElementById('cart-total-display').textContent = `æ€»è®¡: ${grandTotalCost.toLocaleString()}${CURRENCY_SUFFIX}`;
        }

        async function updateCartItem(index, price) {
            if (isNaN(price)) price = 0;
            cloudData.cartData[index].price = price;
            
            // å¦‚æœä»·æ ¼å¤§äº 0ï¼Œåˆ™è‡ªåŠ¨æ ‡è®°ä¸ºå·²è´­ä¹°
            if (price > 0) {
                cloudData.cartData[index].purchased = true;
            } else {
                cloudData.cartData[index].purchased = false;
            }
            
            await saveProductsToCloud();
            renderCart();
        }
        
        async function updatePurchasedStatus(index, purchased) {
            cloudData.cartData[index].purchased = purchased;
            
            // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œåˆ™æ¸…ç©ºä»·æ ¼
            if (!purchased) {
                 cloudData.cartData[index].price = 0;
            }
            
            await saveProductsToCloud();
            renderCart();
        }

        async function clearPrice(index) {
            const item = cloudData.cartData[index];
            if (item.price > 0 || item.purchased) {
                if (confirm(`ç¡®å®šè¦æ¸…ç©º ${item.name} çš„ä»·æ ¼å¹¶æ ‡è®°ä¸ºæœªè´­ä¹°å—ï¼Ÿ`)) {
                    item.price = 0;
                    item.purchased = false;
                    await saveProductsToCloud();
                    renderCart();
                }
            }
        }

        async function copyCartSummary() {
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            let summaryText = `ğŸ›’ é‡‡è´­æ¸…å• - ${today}\n\n`;
            let grandTotalCost = 0;

            cloudData.cartData.forEach(item => {
                if (item.purchased && item.price > 0) {
                    summaryText += `âœ… ${item.name}: ${item.quantity} x ${item.price.toLocaleString()} = ${(item.price * item.quantity).toLocaleString()}${CURRENCY_SUFFIX}\n`;
                    grandTotalCost += item.price * item.quantity;
                } else {
                    summaryText += `â—»ï¸ ${item.name} (æ•°é‡: ${item.quantity})\n`;
                }
            });

            summaryText += `\n--- æ€»è®¡: ${grandTotalCost.toLocaleString()}${CURRENCY_SUFFIX}`;
            
            try {
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(summaryText);
                    alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = summaryText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                }
            } catch (err) {
                console.error('æ— æ³•å¤åˆ¶å†…å®¹:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:\n\n' + summaryText);
            }
        }

        async function resetCart() {
            const cartItems = cloudData.cartData;
            const purchasedItems = cartItems.filter(item => item.purchased && item.price > 0);

            if (purchasedItems.length === 0) {
                alert("æ²¡æœ‰å·²å®Œæˆ (å·²å‹¾é€‰ä¸”å·²å¡«å†™ä»·æ ¼) çš„é¡¹ç›®å¯ä»¥æ¸…ç©ºã€‚");
                return;
            }

            if (confirm(`ç¡®å®šè¦æ¸…ç©º ${purchasedItems.length} ä¸ªå·²å®Œæˆçš„é¡¹ç›®å—ï¼Ÿ`)) {
                cloudData.cartData = cartItems.filter(item => !(item.purchased && item.price > 0));
                
                const saved = await saveProductsToCloud();
                
                if (saved) {
                    renderCart();
                    alert("å·²å®Œæˆçš„é¡¹ç›®å·²æ¸…ç©ºã€‚");
                }
            }
        }

        // --- Tab åˆ‡æ¢å’Œåˆå§‹åŒ– ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove('active');
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add('active');
            if (evt) evt.currentTarget.classList.add("active");

            // æ¯æ¬¡åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“å¯¹åº”å†…å®¹
            if (tabName === 'product-list') {
                renderProductList();
            } else if (tabName === 'cart') {
                renderCart();
            } else if (tabName === 'product-template') {
                renderProductTemplate();
            }
            
            sessionStorage.setItem('activeTab', tabName); 
        }

        // --- é¡µé¢è·³è½¬ (FIXED: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶å `index .html` - ä¿®å¤ç‚¹ï¼) ---
        function goToOrderingPage() {
            window.location.href = 'index .html'; 
        }

        // --- åˆå§‹åŒ–å’ŒåŠ è½½ ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCloudData();
            
            if (!cloudData.productTemplate) cloudData.productTemplate = {};
            if (!cloudData.cartData) cloudData.cartData = [];

            renderCategorySelect();
            
            document.getElementById('loading-overlay').style.display = 'none';

            const savedTab = sessionStorage.getItem('activeTab') || 'product-list';
            const initialButton = document.querySelector(`.tab-button[onclick*="'${savedTab}'"]`);
            
            if (initialButton) {
                // æ¨¡æ‹Ÿç‚¹å‡»åˆå§‹æŒ‰é’®ä»¥è§¦å‘ openTab
                openTab({ currentTarget: initialButton }, savedTab);
            } else {
                // é»˜è®¤æ‰“å¼€ç¬¬ä¸€ä¸ª Tab
                openTab(null, 'product-list'); 
            }
        });
    </script>
</body>
</html>